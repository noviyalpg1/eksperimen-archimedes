import React, { useState, useEffect, useRef } from 'react';
import { Beaker, PlusCircle, MinusCircle, Info, HelpCircle, BookOpen, Maximize, Minimize } from 'lucide-react';

const EggFloatLab = () => {
  const [activeTab, setActiveTab] = useState('lab'); // lab, materi
  const [isFullscreen, setIsFullscreen] = useState(false);
  const containerRef = useRef(null);
  
  // --- KONSTANTA FISIKA ---
  const GRAVITY = 10; // m/s^2
  const EGG_VOLUME = 0.00006; // m^3 (Volume telur rata-rata 60ml)
  const EGG_DENSITY = 1050; // kg/m^3
  const WATER_BASE_DENSITY = 1000; // kg/m^3
  
  const DENSITY_PER_SPOON = 15; 
  const MELAYANG_TOLERANCE = 15; // Toleransi +/- 15 kg/m3 untuk dianggap melayang
  const MAX_SPOONS = 6;

  // --- STATE VARIABEL ---
  const [saltSpoons, setSaltSpoons] = useState(0);
  const [showSaltAnim, setShowSaltAnim] = useState(false);
  const [isPouring, setIsPouring] = useState(false);

  // --- PERHITUNGAN ---
  const waterDensity = WATER_BASE_DENSITY + (saltSpoons * DENSITY_PER_SPOON);
  const eggWeight = EGG_DENSITY * GRAVITY * EGG_VOLUME; // W = m.g = rho.V.g
  
  // Hitung Gaya Apung Maksimum
  const maxBuoyantForce = waterDensity * GRAVITY * EGG_VOLUME;

  // Tentukan Status Telur
  let eggState = 'tenggelam';
  let actualBuoyantForce = 0;
  let submergedPercent = 100;

  if (waterDensity < EGG_DENSITY - MELAYANG_TOLERANCE) {
    eggState = 'tenggelam';
    actualBuoyantForce = maxBuoyantForce;
  } else if (Math.abs(waterDensity - EGG_DENSITY) <= MELAYANG_TOLERANCE) {
    eggState = 'melayang';
    actualBuoyantForce = eggWeight;
  } else {
    eggState = 'mengapung';
    actualBuoyantForce = eggWeight;
    submergedPercent = (EGG_DENSITY / waterDensity) * 100;
  }

  // --- HANDLERS ---
  const addSalt = () => {
    if (saltSpoons < MAX_SPOONS && !isPouring) {
      setIsPouring(true);
      setTimeout(() => {
        setSaltSpoons(prev => prev + 1);
        triggerSaltAnim();
      }, 1000);
      setTimeout(() => setIsPouring(false), 2000);
    }
  };

  const removeSalt = () => {
    if (saltSpoons > 0 && !isPouring) setSaltSpoons(prev => prev - 1);
  };

  const triggerSaltAnim = () => {
    setShowSaltAnim(true);
    setTimeout(() => setShowSaltAnim(false), 2000);
  };

  const toggleFullScreen = () => {
    if (!document.fullscreenElement) {
      containerRef.current.requestFullscreen().then(() => setIsFullscreen(true)).catch(err => console.log(err));
    } else {
      document.exitFullscreen().then(() => setIsFullscreen(false));
    }
  };

  // --- POSISI VISUAL ---
  const getEggTopPosition = () => {
    if (eggState === 'tenggelam') return 'calc(100% - 70px)';
    if (eggState === 'melayang') return '50%';
    const floatOffset = 100 - submergedPercent; 
    return `${20 - (floatOffset / 5)}%`; 
  };

  return (
    <div ref={containerRef} className={`min-h-screen bg-sky-50 font-sans text-slate-800 p-2 md:p-4 overflow-y-auto ${isFullscreen ? 'p-6 bg-white' : ''}`}>
      
      {/* Custom Animations */}
      <style>{`
        @keyframes pourAction {
          0% { transform: translate(150%, -100%) rotate(0deg); opacity: 0; }
          20% { transform: translate(20%, -60%) rotate(0deg); opacity: 1; }
          40% { transform: translate(0%, -40%) rotate(-45deg); }
          60% { transform: translate(0%, -40%) rotate(-45deg); }
          80% { transform: translate(20%, -60%) rotate(0deg); opacity: 1; }
          100% { transform: translate(150%, -100%) rotate(0deg); opacity: 0; }
        }
        @keyframes saltStream {
          0% { height: 0; opacity: 1; }
          50% { height: 100px; opacity: 1; }
          100% { height: 100px; opacity: 0; transform: translateY(50px); }
        }
      `}</style>

      {/* HEADER */}
      <header className={`max-w-4xl mx-auto bg-white rounded-2xl shadow-sm p-3 md:p-4 mb-4 md:mb-6 flex flex-wrap items-center justify-between border-b-4 border-blue-400 transition-all ${isFullscreen ? 'hidden' : ''}`}>
        <div className="flex items-center gap-2 md:gap-3 mb-2 md:mb-0">
          <div className="bg-blue-100 p-2 rounded-full">
            <Beaker className="w-5 h-5 md:w-6 md:h-6 text-blue-600" />
          </div>
          <div>
            <h1 className="text-lg md:text-2xl font-bold text-slate-800 leading-tight">Eksperimen Telur</h1>
            <p className="text-[10px] md:text-xs text-slate-500">Hukum Archimedes</p>
          </div>
        </div>
        
        <div className="flex items-center gap-2 w-full md:w-auto justify-end">
          <div className="flex bg-slate-100 rounded-lg p-1">
            <button 
              onClick={() => setActiveTab('lab')}
              className={`px-3 py-1.5 md:px-4 md:py-2 rounded-md text-xs md:text-sm font-semibold transition ${activeTab === 'lab' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
            >
              Lab
            </button>
            <button 
              onClick={() => setActiveTab('materi')}
              className={`px-3 py-1.5 md:px-4 md:py-2 rounded-md text-xs md:text-sm font-semibold transition ${activeTab === 'materi' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
            >
              Materi
            </button>
          </div>
          <button 
            onClick={toggleFullScreen}
            className="p-2 ml-1 bg-slate-200 hover:bg-slate-300 rounded-lg text-slate-600 transition"
            title="Full Screen"
          >
            {isFullscreen ? <Minimize size={18} /> : <Maximize size={18} />}
          </button>
        </div>
      </header>

      {/* Fullscreen Close Button overlay */}
      {isFullscreen && (
        <button 
          onClick={toggleFullScreen}
          className="fixed top-4 right-4 z-50 bg-white/80 p-3 rounded-full shadow-lg backdrop-blur-sm hover:bg-red-50 text-slate-700"
        >
          <Minimize size={24} />
        </button>
      )}

      {/* MAIN CONTENT AREA */}
      <main className="max-w-4xl mx-auto pb-10">
        
        {/* === TAB LABORATORIUM === */}
        {activeTab === 'lab' && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
            
            {/* LEFT: VISUALIZATION */}
            {/* Responsive Layout: Flex-col on mobile (controls bottom), Block on Desktop (controls absolute top-right) */}
            <div className="bg-white rounded-xl shadow-lg p-4 md:p-6 flex flex-col items-center justify-center relative min-h-[450px] md:min-h-[500px]">
              
              <h2 className="text-base md:text-lg font-bold mb-4 md:mb-8 text-slate-700 w-full border-b pb-2 text-center md:text-left">
                Visualisasi
              </h2>
              
              {/* Controls Panel - Responsive Placement */}
              <div className="order-2 md:order-none md:absolute md:top-20 md:right-6 w-full md:w-auto mt-8 md:mt-0 flex flex-col items-center justify-center md:block">
                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 flex flex-col items-center w-full max-w-[280px] md:w-auto shadow-sm">
                  <span className="text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider">Kontrol Garam</span>
                  <div className="flex items-center justify-between w-full md:justify-center md:gap-4">
                    <button 
                      onClick={removeSalt} 
                      disabled={saltSpoons === 0 || isPouring}
                      className="p-3 md:p-1 bg-white md:bg-transparent border md:border-0 border-red-100 shadow-sm md:shadow-none hover:bg-red-50 rounded-full text-red-500 disabled:opacity-30 disabled:cursor-not-allowed transition active:scale-90"
                    >
                      <MinusCircle className="w-8 h-8 md:w-8 md:h-8" />
                    </button>
                    <div className="flex flex-col items-center min-w-[60px]">
                      <span className="text-3xl md:text-2xl font-bold text-slate-800">{saltSpoons}</span>
                      <span className="text-[10px] text-slate-500 uppercase font-semibold">Sendok</span>
                    </div>
                    <button 
                      onClick={addSalt}
                      disabled={saltSpoons === MAX_SPOONS || isPouring}
                      className="p-3 md:p-1 bg-white md:bg-transparent border md:border-0 border-green-100 shadow-sm md:shadow-none hover:bg-green-50 rounded-full text-green-500 disabled:opacity-30 disabled:cursor-not-allowed transition active:scale-90"
                    >
                      <PlusCircle className="w-8 h-8 md:w-8 md:h-8" />
                    </button>
                  </div>
                  <div className="w-full bg-slate-200 h-1.5 mt-3 rounded-full overflow-hidden">
                    <div className="bg-blue-400 h-full transition-all duration-300" style={{ width: `${(saltSpoons/MAX_SPOONS)*100}%` }}></div>
                  </div>
                </div>
              </div>

              {/* The Glass/Beaker */}
              <div className="relative w-48 h-64 md:w-64 md:h-80 mt-2 md:mt-10 order-1 md:order-none">
                
                {/* ADVANCED SPOON ANIMATION */}
                {isPouring && (
                  <>
                    <div className="absolute top-[-20px] right-[10px] md:top-[0px] md:right-[40px] z-30"
                         style={{ 
                           transformOrigin: '0% 50%',
                           animation: 'pourAction 2s ease-in-out forwards',
                           scale: '0.8' // Slightly smaller on mobile default
                         }}>
                      <svg width="100" height="50" viewBox="0 0 100 50">
                        <rect x="30" y="20" width="70" height="8" rx="2" fill="#94a3b8" />
                        <ellipse cx="30" cy="24" rx="25" ry="12" fill="#cbd5e1" stroke="#94a3b8" strokeWidth="2" />
                        <circle cx="30" cy="22" r="7" fill="white" className="opacity-90" />
                      </svg>
                    </div>

                    <div className="absolute top-[0px] right-[40px] md:top-[20px] md:right-[70px] z-20 w-1 bg-white/80 border-l border-dotted border-white"
                         style={{
                           animation: 'saltStream 0.6s linear forwards',
                           animationDelay: '0.8s'
                         }}
                    ></div>
                  </>
                )}

                {/* Glass Container */}
                <div className="absolute inset-0 border-x-4 border-b-8 border-slate-300 rounded-b-3xl bg-white/10 backdrop-blur-[1px] overflow-hidden z-10">
                  <div className={`absolute bottom-0 w-full h-[85%] transition-colors duration-700 ease-in-out ${
                    saltSpoons > 4 ? 'bg-blue-200/90' : 
                    saltSpoons > 2 ? 'bg-blue-300/80' : 
                    'bg-blue-400/60'
                  }`}>
                    <div className="absolute top-0 w-full h-2 bg-white/40 animate-pulse"></div>
                    {showSaltAnim && (
                      <div className="absolute inset-0 pointer-events-none">
                        {[...Array(25)].map((_, i) => (
                          <div key={i} className="absolute w-1.5 h-1.5 bg-white rounded-full animate-bounce" 
                               style={{ 
                                 top: `${Math.random() * 20}%`,
                                 left: `${30 + Math.random() * 40}%`,
                                 opacity: 0.8,
                                 animation: `ping 1s infinite, bounce ${1 + Math.random()}s infinite`,
                                 animationDelay: `${Math.random() * 0.5}s`
                               }} 
                          />
                        ))}
                      </div>
                    )}
                  </div>

                  {/* The EGG */}
                  <div 
                    className="absolute left-1/2 -translate-x-1/2 w-16 h-22 md:w-20 md:h-28 bg-[#fceabb] rounded-[50%_50%_50%_50%_/_60%_60%_40%_40%] shadow-[inset_-10px_-10px_20px_rgba(0,0,0,0.1)] border border-yellow-200 transition-all duration-1000 ease-in-out flex items-center justify-center z-20 group cursor-help"
                    style={{ top: getEggTopPosition() }}
                  >
                    <div className="absolute top-4 left-4 w-4 h-8 bg-white/60 rounded-full rotate-[30deg]"></div>
                    <div className="absolute inset-0 flex flex-col items-center justify-center opacity-80">
                      <span className="text-[8px] md:text-[10px] font-bold text-slate-600">Telur</span>
                    </div>

                    {/* Vectors */}
                    <div className="absolute top-full flex flex-col items-center">
                       <div className="w-0.5 h-8 md:h-12 bg-red-500"></div>
                       <div className="w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-8 border-t-red-500"></div>
                       <span className="text-red-600 text-[10px] md:text-xs font-bold bg-white/80 px-1 rounded mt-[-5px]">W</span>
                    </div>
                    <div className="absolute bottom-full flex flex-col-reverse items-center">
                       <div 
                         className="w-0.5 bg-green-500 transition-all duration-500" 
                         style={{ height: `${(actualBuoyantForce / eggWeight) * (window.innerWidth < 768 ? 32 : 48)}px` }} 
                       ></div>
                       <div className="w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-8 border-b-green-500"></div>
                       <span className="text-green-600 text-[10px] md:text-xs font-bold bg-white/80 px-1 rounded mb-[-5px]">FA</span>
                    </div>
                  </div>
                </div>
                
                <div className="absolute top-full mt-4 w-full text-center">
                   <div className={`inline-block px-3 py-1 md:px-4 rounded-full text-xs md:text-sm font-bold border shadow-sm ${
                     eggState === 'mengapung' ? 'bg-green-100 text-green-700 border-green-300' :
                     eggState === 'melayang' ? 'bg-yellow-100 text-yellow-700 border-yellow-300' :
                     'bg-red-100 text-red-700 border-red-300'
                   }`}>
                     {eggState.toUpperCase()}
                   </div>
                </div>
              </div>
            </div>

            {/* RIGHT: DATA & EXPLANATION */}
            <div className="flex flex-col gap-4">
              
              {/* Data Panel */}
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-5">
                <h3 className="flex items-center gap-2 text-slate-800 font-bold border-b pb-2 mb-3 text-sm md:text-base">
                  <Info className="w-4 h-4 md:w-5 md:h-5 text-blue-500" />
                  Data Pengamatan
                </h3>
                
                <div className="space-y-2 md:space-y-3">
                  <div className="flex justify-between items-center bg-slate-50 p-2 rounded">
                    <span className="text-xs md:text-sm text-slate-600">Massa Jenis Telur</span>
                    <span className="font-mono text-sm md:text-base font-bold text-slate-800">{EGG_DENSITY} kg/m³</span>
                  </div>
                  
                  <div className="flex justify-between items-center bg-blue-50 p-2 rounded border border-blue-100">
                    <span className="text-xs md:text-sm text-slate-600">Massa Jenis Air</span>
                    <div className="text-right">
                      <span className="font-mono text-sm md:text-base font-bold text-blue-700">{waterDensity} kg/m³</span>
                    </div>
                  </div>

                  <div className="mt-4 pt-2 border-t border-dashed border-slate-300">
                    <p className="text-[10px] md:text-xs text-slate-500 mb-1">Gaya (Archimedes):</p>
                    <div className="grid grid-cols-2 gap-2 text-center">
                      <div className="bg-red-50 p-1.5 md:p-2 rounded border border-red-100">
                        <div className="text-[10px] md:text-xs text-red-500">Berat (W)</div>
                        <div className="font-bold text-sm md:text-base text-red-700">{(eggWeight * 1000).toFixed(1)} mN</div>
                      </div>
                      <div className="bg-green-50 p-1.5 md:p-2 rounded border border-green-100">
                        <div className="text-[10px] md:text-xs text-green-500">Apung (FA)</div>
                        <div className="font-bold text-sm md:text-base text-green-700">{(actualBuoyantForce * 1000).toFixed(1)} mN</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Dynamic Feedback Panel */}
              <div className="bg-amber-50 rounded-xl shadow-sm border border-amber-200 p-4 md:p-5 flex-1">
                <h3 className="font-bold text-amber-800 mb-2 text-sm md:text-base">Kesimpulan:</h3>
                <p className="text-xs md:text-sm text-amber-900 leading-relaxed">
                  {eggState === 'tenggelam' && (
                    <>
                      <strong>Tenggelam</strong> (0-2 Sendok).<br/>
                      ρ Air ({waterDensity}) &lt; ρ Telur ({EGG_DENSITY}).<br/>
                      Gaya apung lemah.
                    </>
                  )}
                  {eggState === 'melayang' && (
                    <>
                      <strong>Melayang</strong> (3-4 Sendok).<br/>
                      ρ Air ({waterDensity}) ≈ ρ Telur.<br/>
                      Gaya apung seimbang.
                    </>
                  )}
                  {eggState === 'mengapung' && (
                    <>
                      <strong>Mengapung</strong> (5-6 Sendok).<br/>
                      ρ Air ({waterDensity}) &gt; ρ Telur.<br/>
                      Gaya apung kuat mendorong naik.
                    </>
                  )}
                </p>
              </div>

            </div>
          </div>
        )}

        {/* === TAB MATERI === */}
        {activeTab === 'materi' && (
          <div className="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <h2 className="text-xl md:text-2xl font-bold text-indigo-900 mb-4 md:mb-6 flex items-center gap-2">
              <BookOpen className="w-5 h-5 md:w-6 md:h-6" />
              Konsep Fisika
            </h2>
            
            <div className="space-y-6">
              <section className="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                <h3 className="font-bold text-blue-900 mb-2 text-sm md:text-base">1. Massa Jenis</h3>
                <p className="text-slate-700 text-xs md:text-sm leading-relaxed">
                  Garam larut mengisi ruang kosong molekul air. Ini membuat air menjadi <strong>lebih padat</strong> (massa jenis naik) tanpa menambah volume air secara signifikan.
                </p>
              </section>

              <section className="bg-indigo-50 p-4 rounded-lg">
                 <h3 className="font-bold text-slate-800 mb-2 text-sm md:text-base">2. Hukum Archimedes</h3>
                 <div className="bg-white p-3 rounded font-mono text-center text-indigo-700 font-bold text-xs md:text-sm border border-indigo-100 mb-2">
                   FA = ρ<sub>fluida</sub> × g × V<sub>tercelup</sub>
                 </div>
                 <p className="text-xs md:text-sm text-slate-600">
                   Jika <strong>ρ fluida</strong> naik (karena garam), maka <strong>FA (Gaya Apung)</strong> juga naik. Saat FA lebih besar dari berat telur, telur akan naik.
                 </p>
              </section>
            </div>
          </div>
        )}

      </main>
      
      {/* Footer */}
      <footer className="max-w-4xl mx-auto mt-8 text-center text-slate-400 text-[10px] md:text-xs pb-4">
        © 2026 Noviyalpg. Semua Hak Dilindungi.
      </footer>
    </div>
  );
};

export default EggFloatLab;
